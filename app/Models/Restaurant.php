<?php

namespace App\Models;

use App\Models\Traits\HasCRUD;
use App\Models\Traits\HasList;
use App\Models\Traits\HasImages;
use Spatie\Sluggable\HasSlug;
use Spatie\Sluggable\SlugOptions;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use DefStudio\Telegraph\Facades\Telegraph;
use DefStudio\Telegraph\Models\TelegraphBot;

class Restaurant extends BaseModel
{
    use HasCRUD, HasList, HasSlug, HasImages, SoftDeletes;

    protected $fillable = [
        'name',
        'slug',
        'description',
        'working_hours',
        'yandex_metrica_code',
        'address',
        'average_receipt',
        'phone',
        'telegram_bot_token',
        'user_id',
        'subtitle'
    ];


    protected $casts = [
        'order' => 'integer',
        'working_hours' => 'array',
        'created_at' => 'datetime',
        'updated_at' => 'datetime',
    ];

    public function getSlugOptions(): SlugOptions
    {
        return SlugOptions::create()
            ->generateSlugsFrom('name')
            ->saveSlugsTo('slug')
            ->allowDuplicateSlugs();
    }

    public function news(): HasMany
    {
        return $this->hasMany(News::class);
    }

    public function events(): HasMany
    {
        return $this->hasMany(Event::class);
    }






















    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ° (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ° Ğ¸ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ²)
     */
    public function users()
    {
        return $this->belongsToMany(User::class);
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ° Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ°
     */
    public function user()
    {
        return $this->belongsTo(User::class);
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ğ¸Ñ… Ñ€Ğ¾Ğ»ÑĞ¼Ğ¸ Ğ² ÑÑ‚Ğ¾Ğ¼ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğµ
     */
    public function getUsersWithRoles()
    {
        // Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ team_id
        $currentTeamId = getPermissionsTeamId();

        // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ team_id ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ°
        setPermissionsTeamId($this->id);

        // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ğ¸Ñ… Ñ€Ğ¾Ğ»ÑĞ¼Ğ¸ Ğ² ÑÑ‚Ğ¾Ğ¼ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğµ
        $users = $this->users()->with(['roles' => function ($query) {
            $query->where('restaurant_id', $this->id);
        }])->get();

        // Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ team_id
        setPermissionsTeamId($currentTeamId);

        return $users;
    }

    /**
     * Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ Ñ€Ğ¾Ğ»ÑŒÑ Ğ² Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½
     */
    public function addUser(User $user, string $role): void
    {
        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ²ÑĞ·ÑŒ Ğ¼Ğ½Ğ¾Ğ³Ğ¸Ğµ-ĞºĞ¾-Ğ¼Ğ½Ğ¾Ğ³Ğ¸Ğ¼ ĞµÑĞ»Ğ¸ ĞµÑ‘ Ğ½ĞµÑ‚
        if (!$this->users()->where('user_id', $user->id)->exists()) {
            $this->users()->attach($user->id);
        }

        // ĞĞ°Ğ·Ğ½Ğ°Ñ‡Ğ°ĞµĞ¼ Ñ€Ğ¾Ğ»ÑŒ Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğµ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ°
        $user->assignRestaurantRole($this->id, $role);
    }

    /**
     * Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ· Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ°
     */
    public function removeUser(User $user): void
    {
        // Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ team_id
        $currentTeamId = getPermissionsTeamId();

        // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ team_id ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ°
        setPermissionsTeamId($this->id);

        // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ²ÑĞµ Ñ€Ğ¾Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ² ÑÑ‚Ğ¾Ğ¼ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğµ
        $user->syncRoles([]);

        // Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ team_id
        setPermissionsTeamId($currentTeamId);

        // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑĞ²ÑĞ·ÑŒ Ğ¼Ğ½Ğ¾Ğ³Ğ¸Ğµ-ĞºĞ¾-Ğ¼Ğ½Ğ¾Ğ³Ğ¸Ğ¼
        $this->users()->detach($user->id);
    }

    /**
     * Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ² Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğµ
     */
    public function changeUserRole(User $user, string $newRole): void
    {
        $user->assignRestaurantRole($this->id, $newRole);
    }

    /**
     * ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Telegram Ğ±Ğ¾Ñ‚Ğ° Ğ´Ğ»Ñ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ°
     */
    public function setupTelegramBot(): array
    {
        if (!$this->telegram_bot_token) {
            return [
                'success' => false,
                'message' => 'Ğ¢Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ° Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½'
            ];
        }

        try {
            // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ±Ğ¾Ñ‚Ğµ Ñ‡ĞµÑ€ĞµĞ· Telegraph
            $botInfoResponse = Telegraph::bot(['token' => $this->telegram_bot_token])->botInfo()->send();
            
            if (!$botInfoResponse->successful()) {
                return [
                    'success' => false,
                    'message' => 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ°'
                ];
            }

            $botInfo = $botInfoResponse->json('result');

            // ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ğ°
            $description = "ğŸ½ {$this->name}\n\n";
            if ($this->subtitle) {
                $description .= "{$this->subtitle}\n\n";
            }
            if ($this->description) {
                $description .= $this->description;
            }

            // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ±Ğ¾Ñ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· Telegraph
            Telegraph::bot(['token' => $this->telegram_bot_token])
                ->registerBotCommands([
                    'start' => 'Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ°',
                    'menu' => 'ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¼ĞµĞ½Ñ',
                    'info' => 'Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğµ',
                    'contact' => 'ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ°'
                ])->send();

            // URL Ğ¼Ğ¸Ğ½Ğ¸-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
            $miniAppUrl = config('app.url') . "/restaurant/{$this->slug}/miniapp";

            // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ¼ĞµĞ½Ñ Ñ Ğ¼Ğ¸Ğ½Ğ¸-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµĞ¼ Ñ‡ĞµÑ€ĞµĞ· Telegraph
            Telegraph::bot(['token' => $this->telegram_bot_token])
                ->setChatMenuButton()
                ->webApp('ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¼ĞµĞ½Ñ', $miniAppUrl)
                ->send();

            // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¸ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· ÑĞ¾Ğ±ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ¼ĞµÑ‚Ğ¾Ğ´Ñ‹
            $this->setBotDescription($description);
            $this->setBotShortDescription($this->subtitle ?: "Ğ ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½ {$this->name}");

            // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ TelegraphBot Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ
            $telegraphBot = $this->getTelegraphBot();

            return [
                'success' => true,
                'message' => 'Ğ‘Ğ¾Ñ‚ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½',
                'bot_info' => $botInfo,
                'miniapp_url' => $miniAppUrl,
                'bot_username' => '@' . $botInfo['username'],
                'telegraph_bot_id' => $telegraphBot->id
            ];

        } catch (\Exception $e) {
            return [
                'success' => false,
                'message' => 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ±Ğ¾Ñ‚Ğ°: ' . $e->getMessage()
            ];
        }
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ TelegraphBot Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ°
     */
    public function getTelegraphBot(): ?TelegraphBot
    {
        if (!$this->telegram_bot_token) {
            return null;
        }

        return TelegraphBot::updateOrCreate(
            ['token' => $this->telegram_bot_token],
            ['name' => $this->name . ' Bot']
        );
    }

    /**
     * ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ, Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ»Ğ¸ Telegram Ğ±Ğ¾Ñ‚
     */
    public function hasTelegramBot(): bool
    {
        return !empty($this->telegram_bot_token);
    }

    /**
     * Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ğ° (ÑĞ¾Ğ±ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Telegraph)
     */
    public function setBotDescription(string $description): bool
    {
        if (!$this->telegram_bot_token) {
            return false;
        }

        try {
            $response = Http::post("https://api.telegram.org/bot{$this->telegram_bot_token}/setMyDescription", [
                'description' => $description
            ]);

            return $response->successful();
        } catch (\Exception $e) {
            Log::error("ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ° Ğ´Ğ»Ñ {$this->name}: " . $e->getMessage());
            return false;
        }
    }

    /**
     * Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ±Ğ¾Ñ‚Ğ° (ÑĞ¾Ğ±ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Telegraph)
     */
    public function setBotShortDescription(string $shortDescription): bool
    {
        if (!$this->telegram_bot_token) {
            return false;
        }

        try {
            $response = Http::post("https://api.telegram.org/bot{$this->telegram_bot_token}/setMyShortDescription", [
                'short_description' => $shortDescription
            ]);

            return $response->successful();
        } catch (\Exception $e) {
            Log::error("ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğ³Ğ¾ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ° Ğ´Ğ»Ñ {$this->name}: " . $e->getMessage());
            return false;
        }
    }

    /**
     * Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ñ‡Ğ°Ñ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· Telegraph (Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ñ‹Ñ… Ñ‡Ğ°Ñ‚Ğ¾Ğ²)
     */
    public function setChatDescription(string $description, $chatId = null): bool
    {
        if (!$this->telegram_bot_token) {
            return false;
        }

        try {
            $telegraph = Telegraph::bot(['token' => $this->telegram_bot_token]);
            
            if ($chatId) {
                // Ğ”Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°
                $response = $telegraph->chat($chatId)->setDescription($description)->send();
            } else {
                // Ğ”Ğ»Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°
                $response = $telegraph->setDescription($description)->send();
            }

            return $response->successful();
        } catch (\Exception $e) {
            Log::error("ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ° Ğ´Ğ»Ñ {$this->name}: " . $e->getMessage());
            return false;
        }
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ±Ğ¾Ñ‚Ğµ
     */
    public function getBotInfo(): ?array
    {
        if (!$this->telegram_bot_token) {
            return null;
        }

        try {
            $response = Telegraph::bot(['token' => $this->telegram_bot_token])->botInfo()->send();
            
            if ($response->successful()) {
                return $response->json('result');
            }
            
            return null;
        } catch (\Exception $e) {
            Log::error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ğ±Ğ¾Ñ‚Ğµ Ğ´Ğ»Ñ {$this->name}: " . $e->getMessage());
            return null;
        }
    }
}
